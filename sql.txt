CREATE DATABASE IF NOT EXISTS db_rms;
USE db_rms;

-- =========================
-- TABLE: users
-- =========================
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(150) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  role ENUM('admin','user') DEFAULT 'user',
  avatar VARCHAR(255),
  phone VARCHAR(20),
  date_of_birth DATE,
  gender ENUM('male','female','other'),
  height_cm DECIMAL(5,2),
  weight_kg DECIMAL(5,2),
  activity_level ENUM('sedentary','light','moderate','active','very_active') DEFAULT 'moderate',
  daily_calorie_goal INT DEFAULT 2000,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  last_login TIMESTAMP NULL,
  is_active TINYINT(1) DEFAULT 1
);

-- =========================
-- TABLE: food_categories
-- =========================
CREATE TABLE food_categories (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL UNIQUE,
  description TEXT,
  icon VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- TABLE: foods
-- =========================
CREATE TABLE foods (
  id INT AUTO_INCREMENT PRIMARY KEY,
  category_id INT,
  name VARCHAR(150) NOT NULL,
  description TEXT,
  calories DECIMAL(8,2) NOT NULL,
  protein DECIMAL(6,2) DEFAULT 0,
  fat DECIMAL(6,2) DEFAULT 0,
  carbs DECIMAL(6,2) DEFAULT 0,
  fiber DECIMAL(6,2) DEFAULT 0,
  sugar DECIMAL(6,2) DEFAULT 0,
  sodium DECIMAL(6,2) DEFAULT 0,
  serving_size VARCHAR(50) DEFAULT '100g',
  image_url VARCHAR(255),
  is_verified TINYINT(1) DEFAULT 0,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- =========================
-- TABLE: meal_types
-- =========================
CREATE TABLE meal_types (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL UNIQUE,
  display_name VARCHAR(50) NOT NULL,
  icon VARCHAR(50),
  sort_order INT DEFAULT 0,
  is_active TINYINT(1) DEFAULT 1
);

-- =========================
-- TABLE: schedules
-- =========================
CREATE TABLE schedules (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  food_id INT NOT NULL,
  meal_type_id INT,
  schedule_date DATE NOT NULL,
  quantity DECIMAL(6,2) DEFAULT 1.00,
  notes TEXT,
  calories_consumed DECIMAL(8,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- =========================
-- TABLE: notifications
-- =========================
CREATE TABLE notifications (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  title VARCHAR(150) NOT NULL,
  message TEXT NOT NULL,
  type ENUM('info','warning','success','error') DEFAULT 'info',
  channel ENUM('email','push','in_app') DEFAULT 'in_app',
  status ENUM('unread','read','sent','failed') DEFAULT 'unread',
  scheduled_at TIMESTAMP NULL,
  sent_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =========================
-- TABLE: user_goals
-- =========================
CREATE TABLE user_goals (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  goal_type ENUM('weight_loss','weight_gain','maintain','muscle_gain') NOT NULL,
  target_weight_kg DECIMAL(5,2),
  target_date DATE,
  weekly_weight_change DECIMAL(3,2),
  daily_calorie_target INT NOT NULL,
  daily_protein_target DECIMAL(6,2),
  daily_fat_target DECIMAL(6,2),
  daily_carbs_target DECIMAL(6,2),
  is_active TINYINT(1) DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- =========================
-- TABLE: user_preferences
-- =========================
CREATE TABLE user_preferences (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  preference_key VARCHAR(50) NOT NULL,
  preference_value TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_preference (user_id, preference_key)
);

-- =========================
-- TABLE: weight_logs
-- =========================
CREATE TABLE weight_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  weight_kg DECIMAL(5,2) NOT NULL,
  body_fat_percentage DECIMAL(4,2),
  muscle_mass_kg DECIMAL(5,2),
  notes TEXT,
  logged_at DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_date (user_id, logged_at)
);

-- =========================
-- INDEXES
-- =========================
CREATE FULLTEXT INDEX idx_food_search ON foods(name, description);
CREATE INDEX idx_schedules_user_date ON schedules(user_id, schedule_date);
CREATE INDEX idx_notifications_user ON notifications(user_id, status);

-- =========================
-- FOREIGN KEYS
-- =========================
ALTER TABLE foods
  ADD FOREIGN KEY (category_id) REFERENCES food_categories(id) ON DELETE SET NULL,
  ADD FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL;

ALTER TABLE schedules
  ADD FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  ADD FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE CASCADE,
  ADD FOREIGN KEY (meal_type_id) REFERENCES meal_types(id) ON DELETE SET NULL;

ALTER TABLE notifications
  ADD FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

ALTER TABLE user_goals
  ADD FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

ALTER TABLE user_preferences
  ADD FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

ALTER TABLE weight_logs
  ADD FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

-- =========================
-- PROCEDURES
-- =========================
DELIMITER $$

CREATE PROCEDURE calculate_meal_calories(IN schedule_id INT)
BEGIN
  UPDATE schedules s
  JOIN foods f ON s.food_id = f.id
  SET s.calories_consumed = f.calories * s.quantity
  WHERE s.id = schedule_id;
END$$

CREATE PROCEDURE get_food_recommendations(
  IN user_id INT,
  IN meal_type VARCHAR(50),
  IN calorie_limit INT
)
BEGIN
  SELECT f.*, fc.name AS category_name
  FROM foods f
  LEFT JOIN food_categories fc ON f.category_id = fc.id
  WHERE f.calories <= calorie_limit
    AND f.is_verified = 1
  ORDER BY f.calories DESC
  LIMIT 10;
END$$

CREATE PROCEDURE update_user_stats(IN user_id INT)
BEGIN
  UPDATE users
  SET last_login = CURRENT_TIMESTAMP
  WHERE id = user_id;

  UPDATE users u
  SET weight_kg = (
    SELECT weight_kg FROM weight_logs
    WHERE user_id = u.id
    ORDER BY logged_at DESC
    LIMIT 1
  )
  WHERE u.id = user_id;
END$$

DELIMITER ;

-- =========================
-- TRIGGERS
-- =========================
DELIMITER $$

CREATE TRIGGER calculate_calories_on_insert
BEFORE INSERT ON schedules
FOR EACH ROW
BEGIN
  SET NEW.calories_consumed =
    (SELECT calories FROM foods WHERE id = NEW.food_id) * NEW.quantity;
END$$

CREATE TRIGGER calculate_calories_on_update
BEFORE UPDATE ON schedules
FOR EACH ROW
BEGIN
  IF NEW.food_id != OLD.food_id OR NEW.quantity != OLD.quantity THEN
    SET NEW.calories_consumed =
      (SELECT calories FROM foods WHERE id = NEW.food_id) * NEW.quantity;
  END IF;
END$$

DELIMITER ;

-- =========================
-- VIEWS
-- =========================
CREATE VIEW daily_nutrition_summary AS
SELECT
  s.user_id,
  s.schedule_date,
  SUM(s.calories_consumed) AS total_calories,
  SUM(f.protein * s.quantity) AS total_protein,
  SUM(f.fat * s.quantity) AS total_fat,
  SUM(f.carbs * s.quantity) AS total_carbs,
  SUM(f.fiber * s.quantity) AS total_fiber,
  COUNT(s.id) AS total_meals
FROM schedules s
JOIN foods f ON s.food_id = f.id
GROUP BY s.user_id, s.schedule_date;

CREATE VIEW user_progress AS
SELECT
  u.id,
  u.name,
  u.daily_calorie_goal,
  COALESCE(AVG(dns.total_calories),0) AS avg_daily_calories,
  COUNT(DISTINCT dns.schedule_date) AS days_logged,
  COALESCE(SUM(dns.total_meals),0) AS total_meals_logged,
  MAX(wl.weight_kg) AS current_weight,
  MIN(wl.weight_kg) AS starting_weight
FROM users u
LEFT JOIN daily_nutrition_summary dns ON u.id = dns.user_id
LEFT JOIN weight_logs wl ON u.id = wl.user_id
WHERE u.is_active = 1
GROUP BY u.id;

COMMIT;
