-- ===========================================
-- RMS (Rekomendasi Makanan Sehat) Database
-- ===========================================
-- Database untuk aplikasi tracking nutrisi dan rekomendasi makanan

-- Membuat database
CREATE DATABASE IF NOT EXISTS rms_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE rms_db;

-- ===========================================
-- TABEL UTAMA
-- ===========================================

-- Tabel Users (Pengguna)
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(150) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'user') DEFAULT 'user',
    avatar VARCHAR(255) NULL,
    phone VARCHAR(20) NULL,
    date_of_birth DATE NULL,
    gender ENUM('male', 'female', 'other') NULL,
    height_cm DECIMAL(5,2) NULL, -- tinggi badan dalam cm
    weight_kg DECIMAL(5,2) NULL, -- berat badan dalam kg
    activity_level ENUM('sedentary', 'light', 'moderate', 'active', 'very_active') DEFAULT 'moderate',
    daily_calorie_goal INT DEFAULT 2000,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE,

    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_created_at (created_at)
);

-- Tabel User Preferences (Preferensi Pengguna)
CREATE TABLE user_preferences (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    preference_key VARCHAR(50) NOT NULL,
    preference_value TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_preference (user_id, preference_key),
    INDEX idx_user (user_id),
    INDEX idx_key (preference_key)
);

-- Tabel Food Categories (Kategori Makanan)
CREATE TABLE food_categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    description TEXT NULL,
    icon VARCHAR(50) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_name (name)
);

-- Tabel Foods (Makanan)
CREATE TABLE foods (
    id INT AUTO_INCREMENT PRIMARY KEY,
    category_id INT NULL,
    name VARCHAR(150) NOT NULL,
    description TEXT NULL,
    calories DECIMAL(8,2) NOT NULL, -- kalori per 100g
    protein DECIMAL(6,2) DEFAULT 0, -- protein dalam gram
    fat DECIMAL(6,2) DEFAULT 0, -- lemak dalam gram
    carbs DECIMAL(6,2) DEFAULT 0, -- karbohidrat dalam gram
    fiber DECIMAL(6,2) DEFAULT 0, -- serat dalam gram
    sugar DECIMAL(6,2) DEFAULT 0, -- gula dalam gram
    sodium DECIMAL(6,2) DEFAULT 0, -- sodium dalam mg
    serving_size VARCHAR(50) DEFAULT '100g', -- ukuran porsi
    image_url VARCHAR(255) NULL,
    is_verified BOOLEAN DEFAULT FALSE,
    created_by INT NULL, -- user yang menambahkan
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (category_id) REFERENCES food_categories(id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,

    INDEX idx_category (category_id),
    INDEX idx_name (name),
    INDEX idx_calories (calories),
    FULLTEXT idx_search (name, description)
);

-- Tabel Meal Types (Jenis Makanan)
CREATE TABLE meal_types (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    display_name VARCHAR(50) NOT NULL,
    icon VARCHAR(50) NULL,
    sort_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,

    INDEX idx_sort_order (sort_order)
);

-- Tabel Schedules (Jadwal Makan)
CREATE TABLE schedules (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    food_id INT NOT NULL,
    meal_type_id INT NULL,
    schedule_date DATE NOT NULL,
    quantity DECIMAL(6,2) DEFAULT 1, -- jumlah porsi
    notes TEXT NULL,
    calories_consumed DECIMAL(8,2) NULL, -- kalori yang dikonsumsi (dihitung otomatis)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE CASCADE,
    FOREIGN KEY (meal_type_id) REFERENCES meal_types(id) ON DELETE SET NULL,

    INDEX idx_user_date (user_id, schedule_date),
    INDEX idx_food (food_id),
    INDEX idx_meal_type (meal_type_id),
    INDEX idx_date (schedule_date)
);

-- Tabel User Goals (Target Pengguna)
CREATE TABLE user_goals (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    goal_type ENUM('weight_loss', 'weight_gain', 'maintain', 'muscle_gain') NOT NULL,
    target_weight_kg DECIMAL(5,2) NULL,
    target_date DATE NULL,
    weekly_weight_change DECIMAL(3,2) NULL, -- perubahan berat per minggu dalam kg
    daily_calorie_target INT NOT NULL,
    daily_protein_target DECIMAL(6,2) NULL,
    daily_fat_target DECIMAL(6,2) NULL,
    daily_carbs_target DECIMAL(6,2) NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    INDEX idx_user (user_id),
    INDEX idx_active (user_id, is_active)
);

-- Tabel Weight Logs (Log Berat Badan)
CREATE TABLE weight_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    weight_kg DECIMAL(5,2) NOT NULL,
    body_fat_percentage DECIMAL(4,2) NULL,
    muscle_mass_kg DECIMAL(5,2) NULL,
    notes TEXT NULL,
    logged_at DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    UNIQUE KEY unique_user_date (user_id, logged_at),
    INDEX idx_user_date (user_id, logged_at)
);

-- Tabel Notifications (Notifikasi)
CREATE TABLE notifications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    title VARCHAR(150) NOT NULL,
    message TEXT NOT NULL,
    type ENUM('info', 'warning', 'success', 'error') DEFAULT 'info',
    channel ENUM('email', 'push', 'in_app') DEFAULT 'in_app',
    status ENUM('unread', 'read', 'sent', 'failed') DEFAULT 'unread',
    scheduled_at TIMESTAMP NULL,
    sent_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

    INDEX idx_user_status (user_id, status),
    INDEX idx_type (type),
    INDEX idx_created_at (created_at)
);

-- Tabel API Logs (untuk Spoonacular API)
CREATE TABLE api_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    endpoint VARCHAR(255) NOT NULL,
    request_data JSON NULL,
    response_data JSON NULL,
    status_code INT NULL,
    error_message TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_endpoint (endpoint),
    INDEX idx_created_at (created_at)
);

-- ===========================================
-- DATA AWAL (SEED DATA)
-- ===========================================

-- Insert meal types
INSERT INTO meal_types (name, display_name, icon, sort_order) VALUES
('breakfast', 'Sarapan', 'sunrise', 1),
('morning_snack', 'Cemilan Pagi', 'cookie', 2),
('lunch', 'Makan Siang', 'sun', 3),
('afternoon_snack', 'Cemilan Sore', 'coffee', 4),
('dinner', 'Makan Malam', 'moon', 5),
('evening_snack', 'Cemilan Malam', 'star', 6);

-- Insert food categories
INSERT INTO food_categories (name, description, icon) VALUES
('protein', 'Sumber protein tinggi', 'egg'),
('vegetables', 'Sayuran dan buah', 'leaf'),
('grains', 'Karbohidrat kompleks', 'wheat'),
('dairy', 'Produk susu', 'cheese'),
('fruits', 'Buah-buahan', 'apple'),
('beverages', 'Minuman', 'cup'),
('snacks', 'Cemilan', 'cookie'),
('fast_food', 'Makanan cepat saji', 'hamburger');

-- Insert sample foods
INSERT INTO foods (category_id, name, description, calories, protein, fat, carbs, fiber, sugar, sodium, serving_size) VALUES
(1, 'Ayam Dada Rebus', 'Dada ayam tanpa kulit direbus', 165, 31, 3.6, 0, 0, 0, 74, '100g'),
(1, 'Telur Rebus', 'Telur ayam rebus', 155, 13, 11, 1.1, 0, 0.5, 124, '1 butir besar'),
(1, 'Tahu', 'Tahu putih', 76, 8.1, 4.3, 1.9, 0.3, 0.5, 8, '100g'),
(1, 'Tempe', 'Tempe kedelai', 193, 18.5, 8.8, 14.6, 2.1, 0.8, 9, '100g'),
(2, 'Bayam', 'Sayur bayam hijau', 23, 2.9, 0.4, 3.6, 2.2, 0.4, 79, '100g'),
(2, 'Wortel', 'Wortel segar', 41, 0.9, 0.2, 9.6, 2.8, 4.7, 69, '100g'),
(2, 'Tomat', 'Tomat merah segar', 18, 0.9, 0.2, 3.9, 1.2, 2.6, 5, '100g'),
(2, 'Kangkung', 'Sayur kangkung', 19, 2.6, 0.2, 3.1, 1.3, 0.4, 31, '100g'),
(3, 'Nasi Putih', 'Nasi putih matang', 130, 2.7, 0.3, 27.9, 0.4, 0.1, 1, '100g'),
(3, 'Oatmeal', 'Oatmeal instan', 379, 13.2, 6.5, 67.7, 10.1, 1, 49, '100g'),
(3, 'Roti Gandum', 'Roti gandum utuh', 247, 12.4, 3.2, 41.3, 6.8, 5.2, 439, '100g'),
(4, 'Susu Sapi', 'Susu sapi full cream', 61, 3.2, 3.3, 4.8, 0, 4.8, 43, '100ml'),
(4, 'Yogurt Plain', 'Yogurt plain tanpa gula', 59, 3.5, 3.3, 4.7, 0, 4.7, 46, '100g'),
(5, 'Apel', 'Apel merah segar', 52, 0.3, 0.2, 13.8, 2.4, 10.4, 1, '1 buah sedang'),
(5, 'Pisang', 'Pisang Cavendish', 89, 1.1, 0.3, 22.8, 2.6, 12.2, 1, '1 buah sedang'),
(5, 'Jeruk', 'Jeruk manis', 47, 0.9, 0.1, 11.8, 2.4, 9.4, 0, '1 buah sedang'),
(7, 'Kacang Almond', 'Kacang almond mentah', 579, 21.2, 49.9, 21.6, 12.5, 4.4, 1, '100g'),
(7, 'Kurma', 'Kurma Medjool', 277, 1.8, 0.2, 74.9, 6.7, 66.5, 1, '100g');

-- Insert sample user (admin)
INSERT INTO users (name, email, password, role) VALUES
('Administrator', 'admin@rms.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'admin');

-- Insert sample user goals
INSERT INTO user_goals (user_id, goal_type, daily_calorie_target, daily_protein_target, daily_fat_target, daily_carbs_target) VALUES
(1, 'maintain', 2000, 150, 67, 250);

-- ===========================================
-- VIEWS UNTUK ANALISIS
-- ===========================================

-- View untuk ringkasan nutrisi harian
CREATE VIEW daily_nutrition_summary AS
SELECT
    s.user_id,
    s.schedule_date,
    SUM(s.calories_consumed) as total_calories,
    SUM(f.protein * s.quantity) as total_protein,
    SUM(f.fat * s.quantity) as total_fat,
    SUM(f.carbs * s.quantity) as total_carbs,
    SUM(f.fiber * s.quantity) as total_fiber,
    COUNT(s.id) as total_meals
FROM schedules s
JOIN foods f ON s.food_id = f.id
GROUP BY s.user_id, s.schedule_date;

-- View untuk progress user
CREATE VIEW user_progress AS
SELECT
    u.id,
    u.name,
    u.daily_calorie_goal,
    COALESCE(AVG(dns.total_calories), 0) as avg_daily_calories,
    COALESCE(SUM(dns.total_meals), 0) as total_meals_logged,
    COUNT(DISTINCT dns.schedule_date) as days_logged,
    MAX(wl.weight_kg) as current_weight,
    MIN(wl.weight_kg) as starting_weight
FROM users u
LEFT JOIN daily_nutrition_summary dns ON u.id = dns.user_id
LEFT JOIN weight_logs wl ON u.id = wl.user_id
WHERE u.is_active = TRUE
GROUP BY u.id, u.name, u.daily_calorie_goal;

-- ===========================================
-- STORED PROCEDURES
-- ===========================================

-- Procedure untuk menghitung kalori yang dikonsumsi
DELIMITER //

CREATE PROCEDURE calculate_meal_calories(IN schedule_id INT)
BEGIN
    UPDATE schedules s
    JOIN foods f ON s.food_id = f.id
    SET s.calories_consumed = f.calories * s.quantity
    WHERE s.id = schedule_id;
END //

-- Procedure untuk mendapatkan rekomendasi makanan
CREATE PROCEDURE get_food_recommendations(
    IN user_id INT,
    IN meal_type VARCHAR(50),
    IN calorie_limit INT
)
BEGIN
    SELECT
        f.*,
        fc.name as category_name
    FROM foods f
    LEFT JOIN food_categories fc ON f.category_id = fc.id
    WHERE f.calories <= calorie_limit
    AND f.is_verified = TRUE
    ORDER BY f.calories DESC
    LIMIT 10;
END //

-- Procedure untuk update user stats
CREATE PROCEDURE update_user_stats(IN user_id INT)
BEGIN
    -- Update last login
    UPDATE users
    SET last_login = CURRENT_TIMESTAMP
    WHERE id = user_id;

    -- Calculate and update current weight from latest log
    UPDATE users u
    SET weight_kg = (
        SELECT weight_kg
        FROM weight_logs wl
        WHERE wl.user_id = u.id
        ORDER BY wl.logged_at DESC
        LIMIT 1
    )
    WHERE u.id = user_id;
END //

DELIMITER ;

-- ===========================================
-- TRIGGERS
-- ===========================================

-- Trigger untuk menghitung kalori otomatis saat insert schedule
DELIMITER //

CREATE TRIGGER calculate_calories_on_insert
    BEFORE INSERT ON schedules
    FOR EACH ROW
BEGIN
    SET NEW.calories_consumed = (
        SELECT calories * NEW.quantity
        FROM foods
        WHERE id = NEW.food_id
    );
END //

-- Trigger untuk menghitung kalori otomatis saat update schedule
CREATE TRIGGER calculate_calories_on_update
    BEFORE UPDATE ON schedules
    FOR EACH ROW
BEGIN
    IF NEW.food_id != OLD.food_id OR NEW.quantity != OLD.quantity THEN
        SET NEW.calories_consumed = (
            SELECT calories * NEW.quantity
            FROM foods
            WHERE id = NEW.food_id
        );
    END IF;
END //

DELIMITER ;

-- ===========================================
-- INDEX TAMBAHAN UNTUK PERFORMA
-- ===========================================

CREATE INDEX idx_schedules_user_date_meal ON schedules (user_id, schedule_date, meal_type_id);
CREATE INDEX idx_foods_category_calories ON foods (category_id, calories);
CREATE INDEX idx_notifications_user_created ON notifications (user_id, created_at);
CREATE INDEX idx_weight_logs_user_date ON weight_logs (user_id, logged_at);

-- ===========================================
-- SAMPLE DATA UNTUK TESTING
-- ===========================================

-- Sample schedule untuk user admin
INSERT INTO schedules (user_id, food_id, meal_type_id, schedule_date, quantity) VALUES
(1, 1, 1, CURDATE(), 1), -- Ayam dada untuk sarapan
(1, 9, 3, CURDATE(), 1), -- Nasi putih untuk makan siang
(1, 2, 5, CURDATE(), 2); -- 2 telur untuk makan malam

-- Sample weight log
INSERT INTO weight_logs (user_id, weight_kg, logged_at) VALUES
(1, 70.5, CURDATE());

-- Sample notifications
INSERT INTO notifications (user_id, title, message, type) VALUES
(1, 'Selamat Datang!', 'Selamat datang di RMS! Mulai tracking nutrisi Anda hari ini.', 'success'),
(1, 'Target Harian', 'Anda telah mencapai 80% dari target kalori harian.', 'info');

COMMIT;
